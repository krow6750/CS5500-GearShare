FROM node:18-alpine

WORKDIR /app

# Install dependencies required for node-gyp and other builds
RUN apk add --no-cache python3 make g++ git

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm install

# Copy the rest of the application
COPY . .

# Create .env file for build time
ARG AIRTABLE_API_KEY
ARG NEXT_PUBLIC_FIREBASE_API_KEY
ARG NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
ARG NEXT_PUBLIC_FIREBASE_PROJECT_ID
ARG NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
ARG NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID
ARG NEXT_PUBLIC_FIREBASE_APP_ID
ARG NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID
ARG NEXT_PUBLIC_AIRTABLE_API_KEY
ARG NEXT_PUBLIC_AIRTABLE_BASE_ID
ARG BOOQABLE_COMPANY_SLUG
ARG BOOQABLE_API_KEY
ARG GMAIL_EMAIL
ARG GMAIL_APP_PASSWORD

# Create .env file
RUN echo "AIRTABLE_API_KEY=${NEXT_PUBLIC_AIRTABLE_API_KEY}" > .env && \
    echo "NEXT_PUBLIC_AIRTABLE_API_KEY=${NEXT_PUBLIC_AIRTABLE_API_KEY}" >> .env && \
    echo "NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}" > .env && \
    echo "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}" >> .env && \
    echo "NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}" >> .env && \
    echo "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}" >> .env && \
    echo "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}" >> .env && \
    echo "NEXT_PUBLIC_FIREBASE_APP_ID=${NEXT_PUBLIC_FIREBASE_APP_ID}" >> .env && \
    echo "NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}" >> .env && \
    echo "NEXT_PUBLIC_AIRTABLE_API_KEY=${NEXT_PUBLIC_AIRTABLE_API_KEY}" >> .env && \
    echo "NEXT_PUBLIC_AIRTABLE_BASE_ID=${NEXT_PUBLIC_AIRTABLE_BASE_ID}" >> .env && \
    echo "BOOQABLE_COMPANY_SLUG=${BOOQABLE_COMPANY_SLUG}" >> .env && \
    echo "BOOQABLE_API_KEY=${BOOQABLE_API_KEY}" >> .env && \
    echo "NEXT_PUBLIC_GMAIL_EMAIL=${GMAIL_EMAIL}" >> .env && \
    echo "NEXT_PUBLIC_GMAIL_APP_PASSWORD=${GMAIL_APP_PASSWORD}" >> .env && \
    echo "GMAIL_EMAIL=${GMAIL_EMAIL}" >> .env && \
    echo "GMAIL_APP_PASSWORD=${GMAIL_APP_PASSWORD}" >> .env

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

RUN npm run build

EXPOSE 3001

CMD ["npm", "start"] 