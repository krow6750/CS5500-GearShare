<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Airtable Data Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    button {
      margin-top: 20px;
      margin-right: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .delete-btn {
      background-color: #f44336;
    }
    .delete-btn:hover {
      background-color: #e53935;
    }
    .update-btn {
      background-color: #2196F3;
    }
    .update-btn:hover {
      background-color: #1976D2;
    }
  </style>
</head>
<body>
  <h1>Airtable Data Management</h1>

  <!-- Repair Tickets -->
  <h2>Repair Tickets</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Item Type</th>
        <th>Damage Description</th>
        <th>Repair Cost</th>
        <th>Status</th>
        <th>Date Submitted</th>
        <th>Actions</th>
      </tr>
    </thead>
  <tbody id="repair-data-table">
   </tbody>
  </table>
  <button id="add-repair-button">Add Repair Ticket</button>
  <button id="sync-repair-button">Sync Repair Tickets</button>

  <!-- Users -->
  <h2>Users</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Email</th>
        <th>Authentication</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="user-data-table">
    </tbody>
  </table>
  <button id="create-user-button">Create User</button>
  <button id="sync-user-button">Sync Users</button>

  <script>
    async function fetchRepairData() {
      try {
        const response = await fetch("/airtable-data");
        if (!response.ok) throw new Error("Failed to fetch repair data");
        const data = await response.json();
        const tableBody = document.getElementById("repair-data-table");
        tableBody.innerHTML = "";
        data.forEach(record => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${record.id}</td>
            <td>${record.firstName || "N/A"}</td>
            <td>${record.lastName || "N/A"}</td>
            <td>${record.itemType || "N/A"}</td>
            <td>${record.damageDescription || "N/A"}</td>
            <td>${record.repairCost || "N/A"}</td>
            <td>${record.status || "N/A"}</td>
            <td>${record.dateSubmitted || "N/A"}</td>
            <td>
              <button class="update-btn" onclick="updateRepairTicket('${record.id}')">Update</button>
              <button class="delete-btn" onclick="deleteRepairTicket('${record.id}')">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error("Error loading repair data:", error);
      }
    }
  
    async function deleteRepairTicket(ticketId) {
      if (!confirm("Are you sure you want to delete this repair ticket?")) return;
      try {
        const response = await fetch(`/repair-ticket/${ticketId}`, { method: "DELETE" });
        if (!response.ok) throw new Error("Failed to delete repair ticket");
        alert("Repair ticket deleted successfully");
        fetchRepairData();
      } catch (error) {
        console.error("Error deleting repair ticket:", error);
      }
    }
  
    async function updateRepairTicket(ticketId) {
      const updates = {};
      updates.firstName = prompt("Enter new First Name (leave blank to skip):");
      updates.lastName = prompt("Enter new Last Name (leave blank to skip):");
      updates.itemType = prompt("Enter new Item Type (leave blank to skip):");
      updates.damageDescription = prompt("Enter new Damage Description (leave blank to skip):");
      updates.repairCost = prompt("Enter new Repair Cost (leave blank to skip):");
      updates.status = prompt("Enter new Status");
  
      Object.keys(updates).forEach(key => {
        if (!updates[key]) delete updates[key];
      });
  
      if (Object.keys(updates).length === 0) return alert("No updates provided.");
  
      try {
        const response = await fetch(`/update-airtable-entry/${ticketId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updates),
        });
        if (!response.ok) throw new Error("Failed to update repair ticket");
        alert("Repair ticket updated successfully");
        fetchRepairData();
      } catch (error) {
        console.error("Error updating repair ticket:", error);
      }
    }
  
    document.getElementById("add-repair-button").addEventListener("click", async () => {
      const firstName = prompt("Enter First Name:");
      const lastName = prompt("Enter Last Name:");
      const itemType = prompt("Enter Item Type:");
      const damageDescription = prompt("Enter Damage Description:");
      const repairCost = prompt("Enter Repair Cost (optional):");
      const status = prompt("Enter Status");
      const dateSubmitted = new Date().toISOString(); 
  
      if (!firstName || !lastName || !itemType || !damageDescription || !status) {
        alert("All required fields must be provided.");
        return;
      }
  
      try {
        const response = await fetch("/repair-ticket", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            firstName,
            lastName,
            itemType,
            damageDescription,
            repairCost: parseFloat(repairCost) || 0,
            status,
            dateSubmitted,
          }),
        });
        if (!response.ok) throw new Error("Failed to add repair ticket");
        alert("Repair ticket added successfully");
        fetchRepairData();
      } catch (error) {
        console.error("Error adding repair ticket:", error);
      }
    });
  
    document.getElementById("sync-repair-button").addEventListener("click", fetchRepairData);
  
    fetchRepairData();

    async function fetchUserData() {
      try {
        const response = await fetch("/users");
        if (!response.ok) throw new Error("Failed to fetch user data");
        const data = await response.json();
        const tableBody = document.getElementById("user-data-table");
        tableBody.innerHTML = "";
        data.forEach(record => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${record.id}</td>
            <td>${record.firstName || "N/A"}</td>
            <td>${record.lastName || "N/A"}</td>
            <td>${record.email || "N/A"}</td>
            <td>${record.authentication || "N/A"}</td>
            <td>
              <button class="update-btn" onclick="updateUser('${record.id}')">Update</button>
              <button class="delete-btn" onclick="deleteUser('${record.id}')">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error("Error loading user data:", error);
      }
    }

    async function deleteUser(userId) {
      if (!confirm("Are you sure you want to delete this user?")) return;
      try {
        const response = await fetch(`/delete-user/${userId}`, { method: "DELETE" });
        if (!response.ok) throw new Error("Failed to delete user");
        alert("User deleted successfully");
        fetchUserData();
      } catch (error) {
        console.error("Error deleting user:", error);
      }
    }

    async function updateUser(userId) {
      const updates = {};
      updates.firstName = prompt("Enter new First Name (leave blank to skip):");
      updates.lastName = prompt("Enter new Last Name (leave blank to skip):");
      updates.email = prompt("Enter new Email (leave blank to skip):");
      updates.authentication = prompt("Enter new Authentication (ordinary/admin, leave blank to skip):");

      Object.keys(updates).forEach(key => {
        if (!updates[key]) delete updates[key];
      });

      if (Object.keys(updates).length === 0) return alert("No updates provided.");

      try {
        const response = await fetch(`/update-user/${userId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updates)
        });
        if (!response.ok) throw new Error("Failed to update user");
        alert("User updated successfully");
        fetchUserData();
      } catch (error) {
        console.error("Error updating user:", error);
      }
    }

    document.getElementById("create-user-button").addEventListener("click", async () => {
      const firstName = prompt("Enter First Name:");
      const lastName = prompt("Enter Last Name:");
      const email = prompt("Enter Email:");
      const password = prompt("Enter Password:");
      if (!firstName || !lastName || !email || !password) {
        alert("All fields are required to create a user.");
        return;
      }
      try {
        const response = await fetch("/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ firstName, lastName, email, password }),
        });
        if (!response.ok) throw new Error("Failed to create user");
        alert("User created successfully");
        fetchUserData();
      } catch (error) {
        console.error("Error creating user:", error);
      }
    });

    document.getElementById("sync-user-button").addEventListener("click", fetchUserData);

    fetchRepairData();
    fetchUserData();
  </script>
</body>
</html>

